<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Script - Admin Panel</title>

    <!-- Prevent indexing during development - REMOVE WHEN READY TO LAUNCH -->
    <meta name="robots" content="noindex, nofollow">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'indesign': '#FF3366',
                        'photoshop': '#31A8FF',
                        'illustrator': '#FF9A00',
                        'primary': '#7f22ea',
                        'primary-dark': '#6b1dd1',
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../css/styles.css">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen pb-20 md:pb-0">
    <!-- Admin Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="flex items-center justify-between px-6 h-16">
            <!-- Logo -->
            <a href="dashboard.html" class="flex items-center space-x-2">
                <img src="../assets/Horizontal_pos.svg" alt="Adoscript" class="h-10">
                <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full">Admin</span>
            </a>

            <!-- Right side -->
            <div class="flex items-center gap-4">
                <a href="../index.html" target="_blank" class="text-gray-600 hover:text-primary transition-colors" title="View Site">
                    <i class="fas fa-external-link-alt"></i>
                </a>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center">
                        <span class="text-primary text-sm font-semibold">A</span>
                    </div>
                    <span class="text-gray-700 font-medium hidden sm:block">Admin</span>
                </div>
                <a href="login.html" class="text-gray-600 hover:text-red-500 transition-colors" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <aside class="admin-sidebar bg-white shadow-sm p-4 hidden md:block">
            <nav class="space-y-1">
                <a href="dashboard.html" class="admin-nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="scripts.html" class="admin-nav-item">
                    <i class="fas fa-file-code"></i>
                    <span>All Scripts</span>
                </a>
                <a href="quick-upload.html" class="admin-nav-item">
                    <i class="fas fa-magic"></i>
                    <span>Quick Upload (AI)</span>
                </a>
                <a href="upload.html" class="admin-nav-item active">
                    <i class="fas fa-upload"></i>
                    <span>Manual Upload</span>
                </a>
                <a href="orders.html" class="admin-nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="settings.html" class="admin-nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <div class="mb-8">
                <h1 id="page-title" class="text-2xl font-bold text-gray-900">Upload New Script</h1>
                <p id="page-subtitle" class="text-gray-600">Add a new script to the marketplace</p>
            </div>

            <form id="upload-form" class="space-y-6">
                <!-- Basic Information -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="script-name" class="block text-sm font-medium text-gray-700 mb-2">Script Name *</label>
                            <input type="text" id="script-name" name="name" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="Enter script name">
                        </div>

                        <div>
                            <label for="application" class="block text-sm font-medium text-gray-700 mb-2">Adobe Application *</label>
                            <select id="application" name="application" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Select application</option>
                                <option value="indesign">InDesign</option>
                                <option value="photoshop">Photoshop</option>
                                <option value="illustrator">Illustrator</option>
                            </select>
                        </div>

                        <div>
                            <label for="version" class="block text-sm font-medium text-gray-700 mb-2">Version</label>
                            <input type="text" id="version" name="version"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="e.g., 1.0.0">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price Type *</label>
                            <div class="flex gap-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="price_type" value="free" class="custom-radio" checked>
                                    <span class="ml-2 text-gray-700">Free</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="price_type" value="paid" class="custom-radio">
                                    <span class="ml-2 text-gray-700">Paid</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="price-input-container" class="mt-4 hidden">
                        <label for="price" class="block text-sm font-medium text-gray-700 mb-2">Price (USD) *</label>
                        <div class="relative max-w-xs">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">$</span>
                            </div>
                            <input type="number" id="price" name="price" step="0.01" min="0"
                                   class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <div class="mt-6">
                        <label for="short-description" class="block text-sm font-medium text-gray-700 mb-2">Short Description * (max 200 characters)</label>
                        <input type="text" id="short-description" name="short_description" maxlength="200" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="Brief description for script cards">
                        <p class="text-sm text-gray-500 mt-1"><span id="char-count">0</span>/200 characters</p>
                    </div>
                </div>

                <!-- Script File Upload -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Script File <span class="text-red-500">*</span></h2>

                    <div class="upload-zone cursor-pointer" onclick="document.getElementById('script-file').click()">
                        <input type="file" id="script-file" name="script_file" accept=".jsx,.jsxbin,.zip" class="hidden">
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-600 mb-2">Drag and drop your script file here, or click to browse</p>
                            <p class="text-sm text-gray-500">Accepted formats: .jsx, .jsxbin, .zip (max 10MB)</p>
                        </div>
                        <div class="upload-preview mt-4"></div>
                    </div>
                </div>

                <!-- Full Description -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Full Description</h2>

                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                        <div class="editor-toolbar bg-gray-50">
                            <button type="button" onclick="formatText('bold')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" onclick="formatText('italic')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" onclick="formatText('underline')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-underline"></i>
                            </button>
                            <span class="border-l border-gray-300 mx-2"></span>
                            <button type="button" onclick="formatText('insertUnorderedList')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button type="button" onclick="formatText('insertOrderedList')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-list-ol"></i>
                            </button>
                            <span class="border-l border-gray-300 mx-2"></span>
                            <button type="button" onclick="formatText('formatBlock', 'h3')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-heading"></i>
                            </button>
                        </div>
                        <div id="full-description" class="editor-content" contenteditable="true">
                            <p>Enter your full script description here...</p>
                        </div>
                    </div>
                </div>

                <!-- Installation Instructions -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Installation Instructions</h2>

                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                        <div class="editor-toolbar bg-gray-50">
                            <button type="button" onclick="formatText('bold', 'installation-instructions')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" onclick="formatText('italic', 'installation-instructions')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" onclick="formatText('insertOrderedList', 'installation-instructions')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-list-ol"></i>
                            </button>
                        </div>
                        <div id="installation-instructions" class="editor-content" contenteditable="true">
                            <p>Enter installation instructions here...</p>
                        </div>
                    </div>
                </div>

                <!-- Usage Instructions -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Usage Instructions</h2>

                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                        <div class="editor-toolbar bg-gray-50">
                            <button type="button" onclick="formatText('bold', 'usage-instructions')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" onclick="formatText('italic', 'usage-instructions')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" onclick="formatText('insertOrderedList', 'usage-instructions')" class="p-2 hover:bg-gray-200 rounded">
                                <i class="fas fa-list-ol"></i>
                            </button>
                        </div>
                        <div id="usage-instructions" class="editor-content" contenteditable="true">
                            <p>Enter usage instructions here...</p>
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Screenshots & Images</h2>

                    <div class="upload-zone cursor-pointer" onclick="document.getElementById('images').click()">
                        <input type="file" id="images" name="images" accept="image/*" multiple class="hidden">
                        <div class="text-center">
                            <i class="fas fa-images text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-600 mb-2">Drag and drop images here, or click to browse</p>
                            <p class="text-sm text-gray-500">Accepted formats: JPG, PNG, GIF (max 5MB each)</p>
                        </div>
                        <div class="upload-preview mt-4 flex flex-wrap"></div>
                    </div>
                </div>

                <!-- Video URLs -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Video Tutorials</h2>

                    <div id="video-urls" class="space-y-4">
                        <div class="flex gap-4">
                            <input type="url" name="video_url[]"
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="YouTube or Vimeo URL">
                            <button type="button" onclick="addVideoUrl()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Additional Information</h2>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="system-requirements" class="block text-sm font-medium text-gray-700 mb-2">System Requirements</label>
                            <textarea id="system-requirements" name="system_requirements" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                                      placeholder="e.g., Adobe InDesign CC 2019+, macOS 10.14+"></textarea>
                        </div>

                        <div>
                            <label for="compatibility" class="block text-sm font-medium text-gray-700 mb-2">Compatibility Notes</label>
                            <textarea id="compatibility" name="compatibility" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                                      placeholder="Any compatibility notes or requirements"></textarea>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label for="tags" class="block text-sm font-medium text-gray-700 mb-2">Tags (comma separated)</label>
                        <input type="text" id="tags" name="tags"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="e.g., export, batch, pdf, automation">
                    </div>

                    <div class="mt-6">
                        <label for="changelog" class="block text-sm font-medium text-gray-700 mb-2">Changelog / Version Notes</label>
                        <textarea id="changelog" name="changelog" rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                                  placeholder="Version history and changes..."></textarea>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white rounded-xl shadow-sm p-6 flex flex-wrap gap-4 justify-end">
                    <button type="button" class="px-6 py-3 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        Save as Draft
                    </button>
                    <button type="button" class="px-6 py-3 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-eye mr-2"></i>
                        Preview
                    </button>
                    <button type="submit" id="submit-btn" class="px-6 py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark transition-colors">
                        <i class="fas fa-check mr-2"></i>
                        <span id="submit-btn-text">Publish Script</span>
                    </button>
                </div>
            </form>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-2">
        <a href="dashboard.html" class="flex flex-col items-center py-2 px-4 text-gray-500">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs mt-1">Dashboard</span>
        </a>
        <a href="scripts.html" class="flex flex-col items-center py-2 px-4 text-gray-500">
            <i class="fas fa-file-code text-xl"></i>
            <span class="text-xs mt-1">Scripts</span>
        </a>
        <a href="upload.html" class="flex flex-col items-center py-2 px-4 text-primary">
            <i class="fas fa-upload text-xl"></i>
            <span class="text-xs mt-1">Upload</span>
        </a>
        <a href="orders.html" class="flex flex-col items-center py-2 px-4 text-gray-500">
            <i class="fas fa-shopping-cart text-xl"></i>
            <span class="text-xs mt-1">Orders</span>
        </a>
    </nav>

    <script src="../js/admin.js"></script>
    <script>
        // Store uploaded file paths
        let uploadedScriptFile = null;
        let uploadedImages = [];

        // Edit mode variables
        let isEditMode = false;
        let editScriptId = null;

        // Check for edit mode on page load
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            if (id) {
                isEditMode = true;
                editScriptId = parseInt(id);
                await loadScriptForEdit(id);
            }
        }

        // Load script data for editing
        async function loadScriptForEdit(id) {
            try {
                // Update page title
                document.getElementById('page-title').textContent = 'Edit Script';
                document.getElementById('page-subtitle').textContent = 'Update script details';
                document.getElementById('submit-btn-text').textContent = 'Update Script';
                document.title = 'Edit Script - Admin Panel';

                // Show loading state
                const form = document.getElementById('upload-form');
                form.style.opacity = '0.5';
                form.style.pointerEvents = 'none';

                const result = await fetchScript(id);
                console.log('Fetch script result:', result);

                // Handle auth redirect
                if (result.redirect) {
                    window.location.href = result.redirect;
                    return;
                }

                if (!result.success) {
                    showToast(result.error || 'Failed to load script', 'error');
                    form.style.opacity = '1';
                    form.style.pointerEvents = 'auto';
                    return;
                }

                if (!result.script) {
                    showToast('Script not found', 'error');
                    window.location.href = 'scripts.html';
                    return;
                }

                const script = result.script;

                // Populate form fields
                document.getElementById('script-name').value = script.name || '';
                document.getElementById('application').value = (script.application || '').toLowerCase();
                document.getElementById('version').value = script.version || '1.0.0';
                document.getElementById('short-description').value = script.short_description || '';
                document.getElementById('char-count').textContent = (script.short_description || '').length;

                // Price type
                const priceType = script.price_type || 'free';
                document.querySelector(`input[name="price_type"][value="${priceType}"]`).checked = true;
                if (priceType === 'paid') {
                    document.getElementById('price-input-container').classList.remove('hidden');
                    document.getElementById('price').value = script.price || 0;
                }

                // Rich text editors
                document.getElementById('full-description').innerHTML = script.full_description || '<p>Enter your full script description here...</p>';
                document.getElementById('installation-instructions').innerHTML = script.installation_instructions || '<p>Enter installation instructions here...</p>';
                document.getElementById('usage-instructions').innerHTML = script.usage_instructions || '<p>Enter usage instructions here...</p>';

                // Additional fields
                document.getElementById('system-requirements').value = script.system_requirements || '';
                document.getElementById('compatibility').value = script.compatibility || '';
                document.getElementById('tags').value = script.tags || '';
                document.getElementById('changelog').value = script.changelog || '';

                // Handle existing script file
                if (script.file_path) {
                    uploadedScriptFile = {
                        file_path: script.file_path,
                        file_size: script.file_size || 'Unknown'
                    };
                    const preview = document.querySelector('#script-file').parentElement.querySelector('.upload-preview');
                    preview.innerHTML = `
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-code text-primary text-xl"></i>
                                <div>
                                    <div class="font-medium">${script.file_path}</div>
                                    <div class="text-sm text-gray-500">${script.file_size || 'Existing file'}</div>
                                </div>
                            </div>
                            <button type="button" onclick="removeScriptFile()" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }

                // Handle existing images
                if (script.images && script.images.length > 0) {
                    uploadedImages = script.images.map(img => ({
                        image_path: img.image_path,
                        url: 'uploads/images/' + img.image_path
                    }));
                    const imagePreview = document.getElementById('images').parentElement.querySelector('.upload-preview');
                    renderImagePreviews(imagePreview);
                }

                // Handle existing videos
                if (script.videos && script.videos.length > 0) {
                    const videoContainer = document.getElementById('video-urls');
                    // Clear default video input
                    videoContainer.innerHTML = '';

                    script.videos.forEach((video, index) => {
                        const videoDiv = document.createElement('div');
                        videoDiv.className = 'flex gap-4';
                        videoDiv.innerHTML = `
                            <input type="url" name="video_url[]" value="${video.video_url || ''}"
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="YouTube or Vimeo URL">
                            ${index === 0 ?
                                `<button type="button" onclick="addVideoUrl()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                    <i class="fas fa-plus"></i>
                                </button>` :
                                `<button type="button" onclick="this.parentElement.remove()" class="px-4 py-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors">
                                    <i class="fas fa-times"></i>
                                </button>`
                            }
                        `;
                        videoContainer.appendChild(videoDiv);
                    });

                    // Add empty input if no videos
                    if (script.videos.length === 0) {
                        addDefaultVideoInput();
                    }
                }

                // Re-enable form
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';

            } catch (error) {
                console.error('Error loading script:', error);
                showToast('Failed to load script', 'error');
            }
        }

        function addDefaultVideoInput() {
            const videoContainer = document.getElementById('video-urls');
            videoContainer.innerHTML = `
                <div class="flex gap-4">
                    <input type="url" name="video_url[]"
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="YouTube or Vimeo URL">
                    <button type="button" onclick="addVideoUrl()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', initPage);

        // Character counter
        const shortDesc = document.getElementById('short-description');
        const charCount = document.getElementById('char-count');

        shortDesc.addEventListener('input', function() {
            charCount.textContent = this.value.length;
        });

        // Price type toggle
        const priceRadios = document.querySelectorAll('input[name="price_type"]');
        const priceContainer = document.getElementById('price-input-container');

        priceRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'paid') {
                    priceContainer.classList.remove('hidden');
                } else {
                    priceContainer.classList.add('hidden');
                }
            });
        });

        // Rich text editor
        function formatText(command, elementId = 'full-description') {
            document.execCommand(command, false, null);
        }

        // Add video URL input
        function addVideoUrl() {
            const container = document.getElementById('video-urls');
            const newInput = document.createElement('div');
            newInput.className = 'flex gap-4';
            newInput.innerHTML = `
                <input type="url" name="video_url[]"
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                       placeholder="YouTube or Vimeo URL">
                <button type="button" onclick="this.parentElement.remove()" class="px-4 py-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(newInput);
        }

        // Handle script file upload
        document.getElementById('script-file').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = this.parentElement.querySelector('.upload-preview');
            preview.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Uploading...</div>';

            try {
                const result = await uploadFile(file, 'script');
                if (result.success) {
                    uploadedScriptFile = result;
                    preview.innerHTML = `
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-code text-primary text-xl"></i>
                                <div>
                                    <div class="font-medium">${result.original_name}</div>
                                    <div class="text-sm text-gray-500">${result.file_size}</div>
                                </div>
                            </div>
                            <button type="button" onclick="removeScriptFile()" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    showToast('Script file uploaded');
                } else {
                    preview.innerHTML = '';
                    showToast(result.error || 'Upload failed', 'error');
                }
            } catch (error) {
                preview.innerHTML = '';
                showToast('Upload failed', 'error');
            }
        });

        function removeScriptFile() {
            uploadedScriptFile = null;
            document.getElementById('script-file').value = '';
            document.querySelector('#script-file').parentElement.querySelector('.upload-preview').innerHTML = '';
        }

        // Handle image uploads
        document.getElementById('images').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files.length) return;

            const preview = this.parentElement.querySelector('.upload-preview');
            preview.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Uploading...</div>';

            try {
                const result = await uploadImages(files);
                if (result.success && result.uploaded.length > 0) {
                    uploadedImages = [...uploadedImages, ...result.uploaded];
                    renderImagePreviews(preview);
                    showToast(`${result.count} image(s) uploaded`);
                } else {
                    showToast(result.errors?.join(', ') || 'Upload failed', 'error');
                }
            } catch (error) {
                showToast('Upload failed', 'error');
            }
        });

        function renderImagePreviews(container) {
            container.innerHTML = uploadedImages.map((img, index) => `
                <div class="relative inline-block m-1">
                    <img src="../${img.url}" alt="" class="w-24 h-24 object-cover rounded-lg">
                    <button type="button" onclick="removeImage(${index})"
                            class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            const preview = document.getElementById('images').parentElement.querySelector('.upload-preview');
            renderImagePreviews(preview);
        }

        // Form submission
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validate script file is uploaded
            if (!uploadedScriptFile) {
                showToast('Please upload a script file before publishing', 'error');
                // Highlight the upload zone
                const uploadZone = document.getElementById('script-file').closest('.upload-zone');
                uploadZone.classList.add('border-red-500', 'border-2');
                uploadZone.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => uploadZone.classList.remove('border-red-500', 'border-2'), 3000);
                return;
            }

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = isEditMode
                ? '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...'
                : '<i class="fas fa-spinner fa-spin mr-2"></i>Publishing...';

            // Collect form data
            const data = {
                name: document.getElementById('script-name').value,
                application: document.getElementById('application').value,
                version: document.getElementById('version').value || '1.0.0',
                price_type: document.querySelector('input[name="price_type"]:checked').value,
                price: document.getElementById('price').value || 0,
                short_description: document.getElementById('short-description').value,
                full_description: document.getElementById('full-description').innerHTML,
                installation_instructions: document.getElementById('installation-instructions').innerHTML,
                usage_instructions: document.getElementById('usage-instructions').innerHTML,
                system_requirements: document.getElementById('system-requirements').value,
                compatibility: document.getElementById('compatibility').value,
                tags: document.getElementById('tags').value,
                changelog: document.getElementById('changelog').value,
                status: 'published',
                file_path: uploadedScriptFile?.file_path || null,
                file_size: uploadedScriptFile?.file_size || null,
                images: uploadedImages.map(img => img.image_path),
                videos: Array.from(document.querySelectorAll('input[name="video_url[]"]'))
                    .map(input => input.value)
                    .filter(url => url.trim() !== '')
            };

            try {
                let result;
                if (isEditMode) {
                    result = await updateScript(editScriptId, data);
                } else {
                    result = await createScript(data);
                }

                if (result.success) {
                    showToast(isEditMode ? 'Script updated successfully!' : 'Script published successfully!');
                    setTimeout(() => {
                        window.location.href = 'scripts.html';
                    }, 1500);
                } else {
                    showToast(result.error || (isEditMode ? 'Failed to update script' : 'Failed to publish script'), 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = isEditMode
                        ? '<i class="fas fa-check mr-2"></i><span>Update Script</span>'
                        : '<i class="fas fa-check mr-2"></i><span>Publish Script</span>';
                }
            } catch (error) {
                showToast(isEditMode ? 'Failed to update script' : 'Failed to publish script', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = isEditMode
                    ? '<i class="fas fa-check mr-2"></i><span>Update Script</span>'
                    : '<i class="fas fa-check mr-2"></i><span>Publish Script</span>';
            }
        });

        // Save as draft
        document.querySelector('button:has(.fa-save)').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            const data = {
                name: document.getElementById('script-name').value || 'Untitled Script',
                application: document.getElementById('application').value || 'indesign',
                version: document.getElementById('version').value || '1.0.0',
                price_type: document.querySelector('input[name="price_type"]:checked')?.value || 'free',
                price: document.getElementById('price').value || 0,
                short_description: document.getElementById('short-description').value || 'Draft script',
                full_description: document.getElementById('full-description').innerHTML,
                installation_instructions: document.getElementById('installation-instructions').innerHTML,
                usage_instructions: document.getElementById('usage-instructions').innerHTML,
                system_requirements: document.getElementById('system-requirements').value,
                compatibility: document.getElementById('compatibility').value,
                tags: document.getElementById('tags').value,
                changelog: document.getElementById('changelog').value,
                status: 'draft',
                file_path: uploadedScriptFile?.file_path || null,
                file_size: uploadedScriptFile?.file_size || null,
                images: uploadedImages.map(img => img.image_path),
                videos: Array.from(document.querySelectorAll('input[name="video_url[]"]'))
                    .map(input => input.value)
                    .filter(url => url.trim() !== '')
            };

            try {
                let result;
                if (isEditMode) {
                    result = await updateScript(editScriptId, data);
                } else {
                    result = await createScript(data);
                }

                if (result.success) {
                    showToast('Draft saved successfully!');
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-save mr-2"></i>Save as Draft';
                } else {
                    showToast(result.error || 'Failed to save draft', 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-save mr-2"></i>Save as Draft';
                }
            } catch (error) {
                showToast('Failed to save draft', 'error');
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-save mr-2"></i>Save as Draft';
            }
        });
    </script>
</body>
</html>
